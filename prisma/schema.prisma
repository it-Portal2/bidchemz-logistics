generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

enum KycStatus {
  PENDING
  VERIFIED
}


model User {
  id          String   @id @default(cuid())
  email       String   @unique
  phone       String?
  password    String
  role        UserRole

  // âœ… NEW FIELDS
  shortId     String?   @unique
  kycStatus   KycStatus? @default(PENDING)

  companyName String?
  gstin       String?
  isVerified  Boolean  @default(false)
  isActive    Boolean  @default(true)
  platform    String?  @default("BIDCHEMZ_LOGISTICS")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  quotes                  Quote[]
  offers                  Offer[]
  partnerCapability       PartnerCapability?
  leadWallet              LeadWallet?
  auditLogs               AuditLog[]
  policyConsents          PolicyConsent[]
  paymentRequests         PaymentRequest[]
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens     PasswordResetToken[]
  notifications           Notification[]

  @@index([email])
  @@index([role])
  @@index([shortId])
}


model EmailVerificationToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}


model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}


model Quote {
  id                    String        @id @default(cuid())
  quoteNumber           String        @unique
  status                QuoteStatus   @default(DRAFT)
  traderId              String
  bidId                 String?       // Optional: BidChemz bid reference
  counterpartyId        String?       // Optional: BidChemz counterparty reference
  cargoName             String
  casNumber             String?
  quantity              Float
  quantityUnit          String
  isHazardous           Boolean
  hazardClass           HazardClass?
  unNumber              String?
  cargoReadyDate        DateTime
  estimatedDeliveryDate DateTime?
  pickupAddress         String
  pickupCity            String
  pickupState           String
  pickupPincode         String
  pickupCountry         String        @default("India")
  pickupContactName     String?
  pickupContactPhone    String?
  deliveryAddress       String
  deliveryCity          String
  deliveryState         String
  deliveryPincode       String
  deliveryCountry       String        @default("India")
  deliveryContactName   String?
  deliveryContactPhone  String?
  packagingType         PackagingType
  packagingDetails      String?
  specialHandling       String?
  temperatureControlled Boolean       @default(false)
  temperatureMin        Float?
  temperatureMax        Float?
  preferredVehicleType  VehicleType[]
  vehicleSpecifications String?
  insuranceRequired     Boolean       @default(false)
  insuranceValue        Float?
  msdsRequired          Boolean       @default(false)
  paymentTerms          String?
  billingAddress        String?
  additionalNotes       String?
  expiresAt             DateTime?
  submittedAt           DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  auditLogs             AuditLog[]
  documents             Document[]
  offers                Offer[]
  trader                User          @relation(fields: [traderId], references: [id])
  shipment              Shipment?

  @@index([traderId])
  @@index([status])
  @@index([cargoReadyDate])
}

model Offer {
  id                  String           @id @default(cuid())
  quoteId             String
  partnerId           String
  status              OfferStatus      @default(PENDING)
  price               Float
  currency            String           @default("INR")
  transitDays         Int
  offerValidUntil     DateTime
  pickupAvailableFrom DateTime
  insuranceIncluded   Boolean          @default(false)
  trackingIncluded    Boolean          @default(true)
  customsClearance    Boolean          @default(false)
  valueAddedServices  String[]
  termsAndConditions  String?
  remarks             String?
  isSelected          Boolean          @default(false)
  selectedAt          DateTime?
  submittedAt         DateTime         @default(now())
  expiresAt           DateTime
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  leadTransaction     LeadTransaction?
  partner             User             @relation(fields: [partnerId], references: [id])
  quote               Quote            @relation(fields: [quoteId], references: [id])
  shipment            Shipment?

  @@index([quoteId])
  @@index([partnerId])
  @@index([status])
}

model Shipment {
  id                 String         @id @default(cuid())
  shipmentNumber     String         @unique
  quoteId            String         @unique
  offerId            String         @unique
  status             ShipmentStatus @default(BOOKED)
  currentLocation    String?
  estimatedDelivery  DateTime?
  actualPickupDate   DateTime?
  actualDeliveryDate DateTime?
  statusUpdates      Json[]
  trackingEvents     Json[]
  podDocument        String?
  podUploadedAt      DateTime?
  deliveryNotes      String?
  rating             Int?
  feedback           String?
  reviewedAt         DateTime?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  auditLogs          AuditLog[]
  documents          Document[]
  offer              Offer          @relation(fields: [offerId], references: [id])
  quote              Quote          @relation(fields: [quoteId], references: [id])

  @@index([shipmentNumber])
  @@index([status])
}

model Document {
  id            String    @id @default(cuid())
  quoteId       String?
  shipmentId    String?
  fileName      String
  fileType      String
  fileSize      Int
  fileUrl       String
  encryptionKey String?
  documentType  String
  uploadedBy    String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  quote         Quote?    @relation(fields: [quoteId], references: [id])
  shipment      Shipment? @relation(fields: [shipmentId], references: [id])

  @@index([quoteId])
  @@index([shipmentId])
}

model PartnerCapability {
  id                    String           @id @default(cuid())
  userId                String           @unique
  serviceTypes          String[]
  dgClasses             HazardClass[]
  productCategories     String[]
  serviceCities         String[]
  serviceStates         String[]
  serviceCountries      String[]
  fleetTypes            VehicleType[]
  fleetCount            Int?
  hasWarehouse          Boolean          @default(false)
  warehouseLocations    String[]
  temperatureControlled Boolean          @default(false)
  temperatureRange      String?
  packagingCapabilities PackagingType[]
  certifications        String[]
  subscriptionTier      SubscriptionTier @default(FREE)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  user                  User             @relation(fields: [userId], references: [id])

  @@index([userId])
}

model LeadWallet {
  id              String            @id @default(cuid())
  userId          String            @unique
  balance         Float             @default(0)
  currency        String            @default("INR")
  lowBalanceAlert Boolean           @default(true)
  alertThreshold  Float             @default(1000)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  transactions    LeadTransaction[]
  user            User              @relation(fields: [userId], references: [id])

  @@index([userId])
}

model LeadTransaction {
  id               String          @id @default(cuid())
  walletId         String
  offerId          String?         @unique
  transactionType  TransactionType
  amount           Float
  description      String?
  leadId           String?
  leadType         LeadType?
  leadCost         Float?
  creditsDeducted  Float?
  hazardCategory   HazardClass?
  routeDistance    Float?
  quantity         Float?
  vehicleType      VehicleType?
  stateWisePricing Json?
  invoiceId        String?
  invoiceUrl       String?
  gstAmount        Float?
  transactionDate  DateTime        @default(now())
  createdAt        DateTime        @default(now())
  offer            Offer?          @relation(fields: [offerId], references: [id])
  wallet           LeadWallet      @relation(fields: [walletId], references: [id])

  @@index([walletId])
  @@index([leadId])
  @@index([transactionType])
}

model PricingTier {
  id                 String           @id @default(cuid())
  tierName           String           @unique
  subscriptionTier   SubscriptionTier @unique
  baseLeadCost       Float
  hazardMultiplier   Json
  distanceMultiplier Json
  quantityMultiplier Json
  vehicleMultiplier  Json
  urgencyMultiplier  Json
  stateWisePricing   Json
  maxLeadsPerDay     Int?
  exclusiveLeads     Boolean          @default(false)
  priorityMatching   Boolean          @default(false)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  @@index([subscriptionTier])
}

model PricingConfig {
  id                   String   @id @default(cuid())
  isActive             Boolean  @default(true)
  baseLeadCost         Float    @default(500)
  hazardNonHazardous   Float    @default(1.0)
  hazardClass1         Float    @default(2.5)
  hazardClass2         Float    @default(1.8)
  hazardClass3         Float    @default(1.6)
  hazardClass4         Float    @default(1.5)
  hazardClass5         Float    @default(1.7)
  hazardClass6         Float    @default(1.9)
  hazardClass7         Float    @default(2.0)
  hazardClass8         Float    @default(1.6)
  hazardClass9         Float    @default(1.3)
  distanceSameState    Float    @default(1.0)
  distanceShort        Float    @default(1.3)
  distanceMedium       Float    @default(1.6)
  distanceLong         Float    @default(2.0)
  quantityRanges       Json
  vehicleTruck         Float    @default(1.0)
  vehicleContainer     Float    @default(1.1)
  vehicleTanker        Float    @default(1.3)
  vehicleIsoTank       Float    @default(1.5)
  vehicleFlatbed       Float    @default(1.1)
  vehicleRefrigerated  Float    @default(1.4)
  urgencyMultiplier    Float    @default(1.3)
  tierPremiumDiscount  Float    @default(0.7)
  tierStandardDiscount Float    @default(0.85)
  tierFreeDiscount     Float    @default(1.0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([isActive])
}

model AuditLog {
  id         String    @id @default(cuid())
  userId     String?
  quoteId    String?
  shipmentId String?
  action     String
  entity     String
  entityId   String
  changes    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime  @default(now())
  quote      Quote?    @relation(fields: [quoteId], references: [id])
  shipment   Shipment? @relation(fields: [shipmentId], references: [id])
  user       User?     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
}

model WebhookLog {
  id            String       @id @default(cuid())
  event         WebhookEvent
  payload       Json
  url           String
  hmacSignature String
  status        Int?
  responseBody  String?
  attempts      Int          @default(0)
  lastAttempt   DateTime?
  createdAt     DateTime     @default(now())

  @@index([event])
  @@index([createdAt])
}

model PolicyConsent {
  id            String    @id @default(cuid())
  userId        String
  policyType    String
  policyVersion String
  accepted      Boolean   @default(false)
  acceptedAt    DateTime?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([policyType])
}

model PaymentRequest {
  id              String               @id @default(cuid())
  userId          String
  amount          Float
  currency        String               @default("INR")
  paymentMethod   PaymentMethod
  status          PaymentRequestStatus @default(PENDING)
  referenceNumber String?
  transactionId   String?
  proofDocument   String?
  paymentDate     DateTime?
  reviewedBy      String?
  reviewedAt      DateTime?
  reviewNotes     String?
  requestNotes    String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  user            User                 @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}


model Notification {
  id        String           @id @default(cuid())
  userId    String
  title     String
  message   String
  priority  NotificationPriority @default(MEDIUM)
  type      String
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  user      User             @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum UserRole {
  TRADER
  LOGISTICS_PARTNER
  ADMIN
}

enum SubscriptionTier {
  FREE
  STANDARD
  PREMIUM
}

enum HazardClass {
  NON_HAZARDOUS
  CLASS_1
  CLASS_2
  CLASS_3
  CLASS_4
  CLASS_5
  CLASS_6
  CLASS_7
  CLASS_8
  CLASS_9
}

enum PackagingType {
  BAGS
  DRUMS
  TANKER
  ISO_TANK
  FLEXITANK
  IBC
  PALLETS
  BULK
}

enum VehicleType {
  TRUCK
  CONTAINER
  TANKER
  ISO_TANK
  FLATBED
  REFRIGERATED
}

enum QuoteStatus {
  DRAFT
  SUBMITTED
  MATCHING
  OFFERS_AVAILABLE
  SELECTED
  CANCELLED
  EXPIRED
}

enum OfferStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
  EXPIRED
}

enum ShipmentStatus {
  BOOKED
  PICKUP_SCHEDULED
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  EXCEPTION
  RETURNED
  CANCELLED
  DELAYED
}

enum LeadType {
  EXCLUSIVE
  SHARED
}

enum TransactionType {
  CREDIT
  DEBIT
  RECHARGE
  REFUND
}

enum WebhookEvent {
  QUOTE_REQUESTED
  QUOTE_OFFERS_AVAILABLE
  QUOTE_OFFER_SELECTED
  SHIPMENT_BOOKED
  SHIPMENT_STATUS_UPDATED
  LEAD_ASSIGNED
  LEAD_PAYMENT_FAILED
}

enum PolicyType {
  TERMS_OF_SERVICE
  PRIVACY_POLICY
  PARTNER_POLICY
}

enum PaymentRequestStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum PaymentMethod {
  BANK_TRANSFER
  UPI
  CHEQUE
  CASH
  ONLINE
}
